<!DOCTYPE html>
<html lang="en">

<head>
    @@include('./layout/head.html')
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>
    <title>光緣畫廊 | KUANG YUAN</title>
</head>

<body>
    <div class="wrapper_melon">
        <div class="header_potter">
            <div class="logo">
                <img src="./img/logo_icon.png" alt="logo">
            </div>
            <div class="con_h6">
                <h6>帳號登出</h6>
            </div>
        </div>
        <section class="sideLeft">
            <div class="content_left">
                <h6 class="wd-border">後臺管理</h6>
                <aside class="side_left">
                    <ul>
                        <ol>
                            <a href="./b_member.html">會員管理</a>
                        </ol>
                        <ol>
                            <a href="#" id="b_color_label" id="b_color_label">訂單管理</a>
                        </ol>
                        <ol>
                            <a href="./b_product.html">商品管理</a>
                        </ol>
                        <ol>
                            <a href="./b_item_exhibits.html">展品管理</a>
                        </ol>
                        <ol>
                            <a href="./b_discount.html">折扣碼管理</a>
                        </ol>
                    </ul>
                </aside>
            </div>
            <div class="sideRight">
                <div class="channel ju_between">
                    <div class="page_title">
                        <h6>訂單管理</h6>
                    </div>
                </div>
                <div class="table_product">
                    <table class="table  align-middle table-striped">
                        <thead>
                            <tr class="table_color">
                                <th scope="col"></th>
                                <th scope="col">訂單編號</th>
                                <!-- <th scope="col">商品編號</th> -->
                                <th scope="col">付款人帳號</th>
                                <th scope="col">價格</th>
                                <th scope="col">付款方式</th>
                                <th scope="col">地址</th>
                                <th scope="col">訂單狀態</th>
                                <th scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- <tr>
                                <th scope="row">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">
                                        <label class="form-check-label" for="flexCheckDefault">
                                        </label>
                                    </div>
                                    <td>1</td>
                                    <td>1</td>
                                    <td>abc123</td>
                                    <td>399</td>
                                    <td>3</td>
                                    <td>信用卡</td>
                                    <td>台北市大安區</td>
                                    <td>準備中</td>
                                    <td>
                                        <button type="button" class="btn btn-primary pa_d" data-bs-toggle="modal" data-bs-target="#order_editBackdrop">
                                            編輯與查看
                                        </button>
                                    </td>
                                </th>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <!-- ---------------------------------------
                編輯訂單
        --------------------------------------- -->
        <section>
            <div class="modal fade" id="order_editBackdrop" data-bs-backdrop="static" data-bs-keyboard="false"
                tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 class="modal-title" id="exampleModalLabel">訂單編輯</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="order_table">
                                    <table id="popup_table">
                                        <!-- <tr class="col">
                                            <th class="col-3">訂單編號</th>
                                            <td class="col-9"></td>
                                        </tr>
                                        <tr>
                                            <th>付款人帳號</th>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <th>價格</th>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <th>數量</th>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <th>地址</th>
                                            <td></td>
                                        </tr> -->
                                        <!-- <tr>
                                            <th>訂單狀態</th>
                                            <td>
                                                &nbsp;<input type="radio" name="status" value="prepare">準備中&nbsp;&nbsp;
                                                <input type="radio" name="status" value="to_be_shipped">待出貨&nbsp;&nbsp;
                                                <input type="radio" name="status" value="shipped">已出貨&nbsp;&nbsp;
                                                <input type="radio" name="status" value="cancel">取消&nbsp;&nbsp;
                                            </td>
                                        </tr> -->
                                    </table>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                                id="closeButton">關閉</button>
                            <!-- <button type="button" class="btn btn-primary">儲存</button> -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script>
        (() => {
            const tbody = document.querySelector('tbody');
            fetch('php/backend/b_order.php')
                .then(resp =>
                    resp.json()
                )
                .then(orderList => {
                    for (let order of orderList) {
                        const { order_id, account, order_detail_price, pay_type, address, order_status } = order;
                        tbody.insertAdjacentHTML('beforebegin', `
                            <tr>
                                <th scope="row">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault-${order_id}">
                                        <label class="form-check-label" for="flexCheckDefaultt-${order_id}">
                                        </label>
                                    </div>
                                    <td id="orderId">${order_id}</td>
                                    <td>${account}</td>
                                    <td>${order_detail_price}</td>
                                    <td>${pay_type}</td>
                                    <td>${address}</td>
                                    <td>${orderStatusTextObject[order_status]}</td>
                                    <td>
                                        <button type="button" class="btn btn-primary pa_d" data-bs-toggle="modal" data-bs-target="#order_editBackdrop" id="button-${order_id}">
                                            編輯與查看
                                        </button>
                                    </td>
                                </th>
                            </tr>`);

                        function change(id, status) {



                        }
                        document.querySelector(`#button-${order_id}`).addEventListener('click', () => {
                            const orderTable = document.querySelector('.order_table');
                            orderTable.innerHTML = `
                                        <table>
                                            <tr class="col">
                                                <th class="col-3">訂單編號</th>
                                                <td class="col-9">${order_id}</td>
                                            </tr>
                                            <tr>
                                                <th>付款人帳號</th>
                                                <td>${account}</td>
                                            </tr>
                                            <tr>
                                                <th>價格</th>
                                                <td>${order_detail_price}</td>
                                            </tr>
                                            <tr>
                                                <th>地址</th>
                                                <td>${address}</td>
                                            </tr>
                                            <tr>
                                                <th>訂單狀態</th>
                                                <td>
                                                    &nbsp;<input ${order_status === 0 ? 'checked' : ''} type="radio" name="status" value="0" onchange="change(${order_id},${'準備中'})">準備中&nbsp;&nbsp;
                                                    <input ${order_status === 1 ? 'checked' : ''} type="radio" name="status" value="1">待出貨&nbsp;&nbsp;
                                                    <input ${order_status === 2 ? 'checked' : ''} type="radio" name="status" value="2">已出貨&nbsp;&nbsp;
                                                    <input ${order_status === 3 ? 'checked' : ''} type="radio" name="status" value="3">取消&nbsp;&nbsp;
                                                </td>
                                            </tr>
                                        </table>`;

                        })
                    }
                });

            document.querySelector('#closeButton').addEventListener('click', e => {
                fetch('php/update_order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderStatus: document.querySelector('input[name=status]:checked').value,
                        orderId: document.querySelector('#orderId').textContent
                    })
                }).then(resp => resp.json)
                    .then(body => {
                        location.reload();
                    });
            });
        })();

        const payStatusTextObject = {
            '0': '未付款',
            '1': '已付款'
        };

        const orderStatusTextObject = {
            '0': '準備中',
            '1': '待出貨',
            '2': '已出貨',
            '3': '取消'
        };
    </script>
</body>

</html>